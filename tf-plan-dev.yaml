
steps:
# Print the name of the git branch
- id: 'Verify Git branch'
  name: alpine/git
  entrypoint: 'sh'
  args:
  - '-c'
  - |
      echo "List all the files in the git directory to verify branch"
      dir = $(ls env) && ls -l env/
      echo "We are in Branch: $BRANCH_NAME"
      if [ $dir == $BRANCH_NAME ]; then
        echo "Directory inside env is ${dir} and it matches ${BRANCH_NAME}"
      else
        echo "Directory: ${dir} does not match git branch: ${BRANCH_NAME}. Exiting!"
        exit 1
      fi
      
# Initilaize Terraform
- id: 'Terraform init'
  name: 'hashicorp/terraform:1.2.9'
  entrypoint: 'sh'
  args:
  - '-c'
  - |
      dir=$(ls env/) && echo $dir
      if [ -d "env/${BRANCH_NAME}/" ]; then
        cd env/${BRANCH_NAME}
        terraform init
      else
       echo "The branch is ${BRANCH_NAME} but the folder inside is ${dir}. Exiting!"
       exit 1
      fi
      
# Generate a Plan 
- id: 'Terraform plan'
  name: 'hashicorp/terraform:1.2.9'
  entrypoint: 'sh'
  args:
  - '-c'
  - |
      cd env/${BRANCH_NAME}/
      terraform plan

# Store Logs in a Bucket     
logsBucket: 'gs://tf-dev-log-bucket'
options:
    logging: GCS_ONLY