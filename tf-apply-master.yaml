steps:
# Print the name of the git branch
- id: 'Verify Git branch'
  name: alpine/git
  entrypoint: 'sh'
  args:
  - '-c'
  - |
    dir=$(ls env)
    echo -e "Files in the git directory: \n $dir" 
    echo "We are in Branch: $BRANCH_NAME"
    if [ $dir == $BRANCH_NAME ]; then
        echo "Directory inside env folder is ${dir} and it matches branch name: ${BRANCH_NAME}. We can proceed with next stage."
    else
        echo "Directory: ${dir} does not match git branch: ${BRANCH_NAME}. Exiting!"
        exit 1
    fi

# Initilaize Terraform
- id: 'Terraform init'
  name: 'hashicorp/terraform:1.2.9'
  entrypoint: 'sh'
  args:
  - '-c'
  - |
    cd env/${BRANCH_NAME} && pwd
    terraform init
      
# Generate a Plan 
- id: 'Terraform plan'
  name: 'hashicorp/terraform:1.2.9'
  entrypoint: 'sh'
  args:
  - '-c'
  - |
    cd env/${BRANCH_NAME}/ && pwd
    terraform plan -out=tfplan

# Apply the Changes
- id: 'Terraform apply'
  name: 'hashicorp/terraform:1.2.9'
  entrypoint: 'sh'
  args:
      - '-c'
      - |
        cd env/${BRANCH_NAME}/ && pwd
        terraform apply -auto-approve tfplan

# Store Logs in a Bucket     
logsBucket: 'gs://logs-cb-cloudbuild'
options:
    logging: GCS_ONLY
